<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange â€” ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css?v=4" />
  <script src="./pricing.js?v=4"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header>
  <img src="./assets/logo.png" class="logo" alt="Poiz Exchange">
  <div class="currency-strip">ğŸ‡·ğŸ‡º â‚½ Â· ğŸ‡¨ğŸ‡³ Â¥ Â· ğŸ‡ºğŸ‡¸ $ Â· ğŸ’² USDT</div>
</header>

<main>
  <h2>ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°</h2>

  <label>ĞÑ‚Ğ´Ğ°Ñ</label>
  <select id="from"></select>

  <label>ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ</label>
  <select id="to"></select>

  <div id="rubcnyModeBox">
    <button id="modeByY" class="btn-ghost">RUBâ†’CNY Ğ¿Ğ¾ Â¥</button>
    <button id="modeFix10" class="btn-ghost">RUBâ†’CNY Ñ„Ğ¸ĞºÑ 10</button>
  </div>

  <label>Ğ¡ÑƒĞ¼Ğ¼Ğ°</label>
  <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" />

  <div id="result" class="result">ĞšÑƒÑ€Ñ: â€” | Ğš Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ: â€”</div>

  <h2>Ğ—Ğ°ÑĞ²ĞºĞ°</h2>

  <label>ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚</label>
  <input id="contact" placeholder="@username Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½" />

  <label>Ğ ĞµĞºĞ²Ğ¸Ğ·Ğ¸Ñ‚Ñ‹</label>
  <textarea id="requisites" placeholder="ĞĞ¾Ğ¼ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ñ‹/ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°, Ğ±Ğ°Ğ½Ğº, Ğ¤Ğ˜Ğ"></textarea>

  <label>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</label>
  <textarea id="note" placeholder="Ğ“Ğ¾Ñ€Ğ¾Ğ´, Ğ±Ğ°Ğ½Ğº, ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒâ€¦"></textarea>

  <label>QR-Ñ„Ğ°Ğ¹Ğ» (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)</label>
  <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />

  <button id="sendBtn">ğŸ“© ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ</button>
</main>

<footer>
  <a href="https://t.me/poizchat" target="_blank">ğŸ’¬ Ğ§Ğ°Ñ‚</a>
  <a href="https://t.me/poizmanager" target="_blank">ğŸ“ ĞĞ´Ğ¼Ğ¸Ğ½</a>
  <a href="./rates.html?v=4">ğŸ“Š Ğ¢Ğ°Ğ±Ğ»Ğ¾</a>
</footer>

<script>
  const tg = window.Telegram?.WebApp; if (tg) tg.expand();

  // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ¿Ğ¸ÑĞºĞ¾Ğ²
  const selFrom=document.getElementById('from'), selTo=document.getElementById('to');
  CURRENCIES.forEach(c=>{
    const o1=new Option(c.title,c.code);
    const o2=new Option(c.title,c.code);
    selFrom.add(o1); selTo.add(o2);
  });

  // ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· URL (?from=&to=) Ğ¸Ğ»Ğ¸ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚
  const qs=new URLSearchParams(location.search);
  selFrom.value = qs.get('from') || 'USDT';
  selTo.value   = qs.get('to')   || 'RUB';

  let rubCnyMode="byy"; // Ñ€ĞµĞ¶Ğ¸Ğ¼ RUBâ†’CNY: Ğ¿Ğ¾ Â¥ (byy) Ğ¸Ğ»Ğ¸ Ñ„Ğ¸ĞºÑ 10 (fix)
  const modeBox=document.getElementById('rubcnyModeBox');
  const btnByY=document.getElementById('modeByY');
  const btnFix=document.getElementById('modeFix10');
  const amt=document.getElementById('amount');
  const res=document.getElementById('result');

  function updateMode(){
    modeBox.style.display = (selFrom.value==='RUB' && selTo.value==='CNY') ? 'flex' : 'none';
  }

  function recalc(){
    updateMode();
    const dir = buildDirection(selFrom.value, selTo.value, rubCnyMode);
    const a   = parseFloat(amt.value||'0');
    const q   = quote(dir, a);
    if(!q){ res.textContent = 'ĞšÑƒÑ€Ñ: â€” | Ğš Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ: â€”'; return null; }
    res.textContent = `ĞšÑƒÑ€Ñ: ${q.rate} | Ğš Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ: ${formatN(q.total)}`;
    return {dir, a, rate:q.rate, total:q.total};
  }

  btnByY.onclick = ()=>{ rubCnyMode='byy'; recalc(); };
  btnFix.onclick = ()=>{ rubCnyMode='fix'; recalc(); };

  selFrom.onchange = recalc;
  selTo.onchange   = recalc;
  amt.oninput      = recalc;
  recalc();

  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°ÑĞ²ĞºĞ¸ Ğ² Ğ±Ğ¾Ñ‚Ğ°
  document.getElementById('sendBtn').onclick = ()=>{
    const r = recalc(); if(!r) return;
    const payload = {
      action:'request',
      direction:r.dir,
      amount:r.a,
      contact:document.getElementById('contact').value.trim(),
      requisites:document.getElementById('requisites').value.trim(),
      note:document.getElementById('note').value.trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };
    if (tg){ tg.sendData(JSON.stringify(payload)); tg.close(); }
    else { alert('ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Telegram'); }
  };
</script>
</body>
</html>
