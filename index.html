<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css?v=34b" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="./pricing.js?v=34b"></script>
</head>
<body>
<header class="appbar">
  <h1>–ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –û–ë–ú–ï–ù–ê</h1>
</header>

<main class="container">

  <!-- –û–¢–î–ê–Æ -->
  <section class="card">
    <h2>–û—Ç–¥–∞—é</h2>

    <div class="pill-group" id="fromPay">
      <button class="pill active" data-pay="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</button>
      <button class="pill" data-pay="bank">üè¶ –ë–∞–Ω–∫</button>
      <button class="pill" data-pay="crypto">ü™ô –ö—Ä–∏–ø—Ç–æ</button>
      <button class="pill" data-pay="cn">üà∂ –ö–∏—Ç–∞–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã</button>
    </div>

    <div class="tiles" id="fromTiles">
      <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ pricing.js -->
    </div>

    <div class="city-row" id="fromCityRow" hidden>
      <label>–ì–æ—Ä–æ–¥</label>
      <select id="fromCity">
        <option value="moscow" selected>–ú–æ—Å–∫–≤–∞</option>
        <option value="gz">–ì—É–∞–Ω—á–∂–æ—É</option>
      </select>
    </div>
  </section>

  <!-- –ü–û–õ–£–ß–ê–Æ -->
  <section class="card">
    <h2>–ü–æ–ª—É—á–∞—é</h2>

    <div class="pill-group" id="toPay">
      <button class="pill" data-pay="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</button>
      <button class="pill" data-pay="bank">üè¶ –ë–∞–Ω–∫</button>
      <button class="pill" data-pay="crypto">ü™ô –ö—Ä–∏–ø—Ç–æ</button>
      <button class="pill active" data-pay="cn">üà∂ –ö–∏—Ç–∞–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã</button>
    </div>

    <div class="tiles" id="toTiles">
      <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ pricing.js -->
    </div>

    <div class="city-row" id="toCityRow" hidden>
      <label>–ì–æ—Ä–æ–¥</label>
      <select id="toCity">
        <option value="moscow" selected>–ú–æ—Å–∫–≤–∞</option>
        <option value="gz">–ì—É–∞–Ω—á–∂–æ—É</option>
      </select>
    </div>
  </section>

  <!-- –†–ê–°–ß–Å–¢ -->
  <section class="card">
    <div class="grid-2">
      <div>
        <label>–°—É–º–º–∞</label>
        <input id="amount" type="number" min="0" step="0.01" placeholder="0.00" />
      </div>
      <div class="quote">
        <div><span>–ö—É—Ä—Å</span><strong id="rate">‚Äî</strong></div>
        <div><span>–ö –ø–æ–ª—É—á–µ–Ω–∏—é</span><strong id="total">‚Äî</strong></div>
      </div>
    </div>
  </section>

  <!-- –ó–ê–Ø–í–ö–ê -->
  <section class="card">
    <h2>–ó–∞—è–≤–∫–∞</h2>

    <div class="grid-2">
      <div>
        <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
        <input id="contact" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" />
      </div>
      <div>
        <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
        <input id="requisites" placeholder="–ö–∞—Ä—Ç–∞/–∫–æ—à–µ–ª—ë–∫, –±–∞–Ω–∫, –§–ò–û" />
      </div>
    </div>

    <div>
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="note" rows="3" placeholder="–ì–æ—Ä–æ–¥, –±–∞–Ω–∫, —Å—Ä–æ—á–Ω–æ—Å—Ç—å‚Ä¶"></textarea>
    </div>

    <div id="qrRow" hidden>
      <label>QR-—Ñ–∞–π–ª (—Ç–æ–ª—å–∫–æ –¥–ª—è Alipay/WeChat/–∫–∞—Ä—Ç –ö–∏—Ç–∞—è)</label>
      <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />
    </div>

    <button id="sendBtn" class="btn-main">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  </section>

  <footer class="footer">
    <a href="./rates.html?v=34b" class="link">üìä –¢–∞–±–ª–æ –∫—É—Ä—Å–æ–≤</a>
    <a href="https://t.me/poizchat" target="_blank" class="link">üí¨ –ß–∞—Ç</a>
    <a href="https://t.me/poizmanager" target="_blank" class="link">üìû –ê–¥–º–∏–Ω</a>
  </footer>
</main>

<script>
  const tg = window.Telegram?.WebApp; tg && tg.expand();

  // —ç–ª–µ–º–µ–Ω—Ç—ã
  const fromPay = document.getElementById('fromPay');
  const toPay   = document.getElementById('toPay');
  const fromTiles = document.getElementById('fromTiles');
  const toTiles   = document.getElementById('toTiles');
  const fromCityRow = document.getElementById('fromCityRow');
  const toCityRow   = document.getElementById('toCityRow');
  const amount = document.getElementById('amount');
  const rateEl = document.getElementById('rate');
  const totalEl = document.getElementById('total');
  const qrRow = document.getElementById('qrRow');

  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    from: { pay:'cash', asset:null, city:'moscow' },
    to:   { pay:'cn',   asset:null, city:'moscow' },
    amount: 0
  };

  // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–ª–∏—Ç–æ–∫
  function drawTiles(side){
    const box = side==='from' ? fromTiles : toTiles;
    const pay = state[side].pay;
    const list = getAssetsByPay(pay, side);
    box.innerHTML = '';
    list.forEach(a=>{
      const b = document.createElement('button');
      b.className = 'tile' + (state[side].asset===a.code ? ' active':'');
      b.innerHTML = `<img src="${a.icon}" alt=""><span>${a.title}</span>`;
      b.onclick = ()=>{ state[side].asset = a.code; onChange(); drawTiles(side); };
      box.appendChild(b);
    });
    // –≥–æ—Ä–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö
    (side==='from'?fromCityRow:toCityRow).hidden = (pay!=='cash');
    // QR ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤ CN —Å–µ—Ä–≤–∏—Å—ã
    qrRow.hidden = !(state.to.pay==='cn');
  }

  // –∫–ª–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ–ø–ª–∞—Ç
  function bindPayGroup(node, side){
    node.querySelectorAll('.pill').forEach(p=>{
      p.onclick = ()=>{
        node.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        state[side].pay = p.dataset.pay;
        state[side].asset = null;
        drawTiles(side);
        onChange();
      };
    });
  }
  bindPayGroup(fromPay,'from');
  bindPayGroup(toPay,'to');

  // –≤–≤–æ–¥ —Å—É–º–º—ã
  amount.oninput = ()=>{ state.amount = parseFloat(amount.value||'0'); onChange(); };

  // —Å—Ç–∞—Ä—Ç
  drawTiles('from'); drawTiles('to'); onChange();

  // –ø–µ—Ä–µ—Å—á—ë—Ç
  function onChange(){
    const q = quote(state);
    if(!q || !isFinite(q.rate) || !isFinite(q.total)){
      rateEl.textContent = '‚Äî';
      totalEl.textContent = '‚Äî';
    }else{
      rateEl.textContent = q.rate_label || q.rate.toString();
      totalEl.textContent = formatN(q.total);
    }
  }

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏
  document.getElementById('sendBtn').onclick = ()=>{
    const payload = {
      action: 'request', // –í–ê–ñ–ù–û: —Ç–∞–∫ –∂–¥—ë—Ç –±–æ—Ç
      from: state.from,
      to: state.to,
      amount: state.amount,
      rate: rateEl.textContent,
      total: totalEl.textContent,
      contact: document.getElementById('contact').value.trim(),
      requisites: document.getElementById('requisites').value.trim(),
      note: document.getElementById('note').value.trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };
    if(window.Telegram?.WebApp){
      tg.sendData(JSON.stringify(payload));
      tg.close();
    }else{
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É.');
    }
  };
</script>
</body>
</html>

