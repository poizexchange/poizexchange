<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange — Калькулятор</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://telegram.org">
  <link rel="stylesheet" href="./styles.css?v=18" />
  <script src="./pricing.js?v=18"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header class="header">
  <div class="brand-strip">
    <span>🇷🇺 ₽</span><span>·</span><span>🇨🇳 ¥</span><span>·</span><span>🇺🇸 $</span><span>·</span><span>💲 USDT</span>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1 class="title">Калькулятор обмена</h1>

    <!-- Шаг 1 -->
    <div class="step-caption">Шаг 1 · Вы отдаёте</div>
    <div id="coinsFrom" class="coins"></div>

    <!-- Шаг 2 -->
    <div class="step-caption">Шаг 2 · Вы получаете</div>
    <div id="coinsTo" class="coins"></div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>Сумма</label>
        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
      </div>
      <div>
        <label>Курс/Итог</label>
        <div id="result" class="resultBox">Курс: — | К получению: —</div>
      </div>
    </div>

    <div class="divider"></div>

    <h2 class="subtitle">Заявка</h2>
    <div class="grid2">
      <div>
        <label>Контакт</label>
        <input id="contact" placeholder="@username или телефон" />
      </div>
      <div>
        <label>QR-файл (опционально)</label>
        <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />
      </div>
    </div>

    <label>Реквизиты</label>
    <textarea id="requisites" placeholder="Номер карты/кошелька, банк, ФИО"></textarea>

    <label>Комментарий</label>
    <textarea id="note" placeholder="Город, банк, срочность…"></textarea>

    <button id="sendBtn" class="btn-primary">📩 Отправить заявку</button>
    <p id="hint" class="hint" hidden>Откройте форму через кнопку в Telegram, чтобы отправить заявку напрямую боту.</p>
  </section>

  <nav class="actions">
    <a class="link" href="https://t.me/poizchat" target="_blank">💬 Чат</a>
    <a class="link" href="https://t.me/poizmanager" target="_blank">📞 Админ</a>
    <a class="link" href="./rates.html?v=18">📊 Табло</a>
  </nav>
</main>

<script>
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) { tg.expand(); tg.ready(); }
  function isInsideTelegram(){ try { return !!(tg && tg.initDataUnsafe && tg.platform); } catch(e){ return false; } }

  const coinsFrom = document.getElementById('coinsFrom');
  const coinsTo   = document.getElementById('coinsTo');
  const amt       = document.getElementById('amount');
  const res       = document.getElementById('result');
  const hint      = document.getElementById('hint');

  const ICON_CLASS = {
    USD:"usd", USDT:"usdt", CNY:"cny", BTC:"btc", ETH:"eth", XMR:"xmr", RUB:"rub"
  };

  let FROM = "USDT";
  let TO   = "RUB";

  function coinTile(code){
    const div = document.createElement('div');
    div.className = 'coin';
    div.dataset.code = code;
    const ic = document.createElement('span');
    ic.className = 'icon ' + (ICON_CLASS[code]||'');
    const cap = document.createElement('div');
    cap.className = 'cap';
    cap.textContent = code;
    div.append(ic, cap);
    return div;
  }

  function renderCoins(){
    coinsFrom.innerHTML = '';
    coinsTo.innerHTML   = '';

    CURRENCIES.forEach(c=>{
      const t1 = coinTile(c.code);
      if (c.code === FROM) t1.classList.add('active');
      t1.onclick = ()=>{ FROM=c.code; if (TO===FROM){ // выберем другой TO
        TO = (CURRENCIES.find(x=>x.code!=="RUB" && x.code!==FROM)?.code) || "RUB";
      } renderCoins(); recalc(); };
      coinsFrom.appendChild(t1);

      const t2 = coinTile(c.code);
      if (c.code === TO) t2.classList.add('active');
      if (c.code === FROM) { t2.style.opacity=.4; t2.style.pointerEvents='none'; }
      t2.onclick = ()=>{ TO=c.code; if (TO===FROM){ FROM="RUB"; } renderCoins(); recalc(); };
      coinsTo.appendChild(t2);
    });
  }

  function recalc(){
    const a = parseFloat(amt.value||'0');
    const q = quotePair(FROM, TO, a);
    if (!q){ res.textContent='Курс: — | К получению: —'; return null; }
    res.textContent = `Курс: ${q.rate.toFixed(6)} | К получению: ${formatN(q.total)}`;
    return { from: FROM, to: TO, a, rate:q.rate, total:q.total };
  }

  amt.oninput = recalc;
  renderCoins(); recalc();

  if (!isInsideTelegram()) hint.hidden = false;

  // Отправка заявки через tg.sendData (как раньше)
  document.getElementById('sendBtn').onclick = ()=>{
    const r = recalc(); if(!r){ alert('Введите сумму'); return; }
    const payload = {
      action: 'request',
      direction: `${r.from}>${r.to}`,
      amount: r.a,
      contact: (document.getElementById('contact').value || '').trim(),
      requisites: (document.getElementById('requisites').value || '').trim(),
      note: (document.getElementById('note').value || '').trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };
    if (isInsideTelegram()){
      try{
        tg.HapticFeedback?.impactOccurred('medium');
        tg.showPopup?.({ title: 'Отправка', message: 'Заявка отправляется…' });
        tg.sendData(JSON.stringify(payload));
        tg.close();
      }catch(e){
        console.error(e);
        alert('Ошибка отправки через Telegram. Попробуйте ещё раз.');
      }
    } else {
      alert('Откройте эту страницу из кнопки бота в Telegram, чтобы отправить заявку.');
    }
  };

  // «живой» фон
  document.addEventListener('scroll', () => {
    const y = window.scrollY || 0;
    document.body.style.setProperty('--bg-shift', (y * 0.03).toFixed(2) + 'px');
  }, {passive:true});
</script>
</body>
</html>
