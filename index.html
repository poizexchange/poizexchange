<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange โ ะะฐะปัะบัะปััะพั</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://telegram.org">
  <link rel="stylesheet" href="./styles.css?v=18" />
  <script src="./pricing.js?v=18"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header class="header">
  <div class="brand-strip">
    <span>๐ท๐บ โฝ</span><span>ยท</span><span>๐จ๐ณ ยฅ</span><span>ยท</span><span>๐บ๐ธ $</span><span>ยท</span><span>๐ฒ USDT</span>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1 class="title">ะะฐะปัะบัะปััะพั ะพะฑะผะตะฝะฐ</h1>

    <!-- ะจะฐะณ 1 -->
    <div class="step-caption">ะจะฐะณ 1 ยท ะั ะพัะดะฐััะต</div>
    <div id="coinsFrom" class="coins"></div>

    <!-- ะจะฐะณ 2 -->
    <div class="step-caption">ะจะฐะณ 2 ยท ะั ะฟะพะปััะฐะตัะต</div>
    <div id="coinsTo" class="coins"></div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>ะกัะผะผะฐ</label>
        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
      </div>
      <div>
        <label>ะััั/ะัะพะณ</label>
        <div id="result" class="resultBox">ะััั: โ | ะ ะฟะพะปััะตะฝะธั: โ</div>
      </div>
    </div>

    <div class="divider"></div>

    <h2 class="subtitle">ะะฐัะฒะบะฐ</h2>
    <div class="grid2">
      <div>
        <label>ะะพะฝัะฐะบั</label>
        <input id="contact" placeholder="@username ะธะปะธ ัะตะปะตัะพะฝ" />
      </div>
      <div>
        <label>QR-ัะฐะนะป (ะพะฟัะธะพะฝะฐะปัะฝะพ)</label>
        <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />
      </div>
    </div>

    <label>ะะตะบะฒะธะทะธัั</label>
    <textarea id="requisites" placeholder="ะะพะผะตั ะบะฐััั/ะบะพัะตะปัะบะฐ, ะฑะฐะฝะบ, ะคะะ"></textarea>

    <label>ะะพะผะผะตะฝัะฐัะธะน</label>
    <textarea id="note" placeholder="ะะพัะพะด, ะฑะฐะฝะบ, ััะพัะฝะพัััโฆ"></textarea>

    <button id="sendBtn" class="btn-primary">๐ฉ ะัะฟัะฐะฒะธัั ะทะฐัะฒะบั</button>
    <p id="hint" class="hint" hidden>ะัะบัะพะนัะต ัะพัะผั ัะตัะตะท ะบะฝะพะฟะบั ะฒ Telegram, ััะพะฑั ะพัะฟัะฐะฒะธัั ะทะฐัะฒะบั ะฝะฐะฟััะผัั ะฑะพัั.</p>
  </section>

  <nav class="actions">
    <a class="link" href="https://t.me/poizchat" target="_blank">๐ฌ ะงะฐั</a>
    <a class="link" href="https://t.me/poizmanager" target="_blank">๐ ะะดะผะธะฝ</a>
    <a class="link" href="./rates.html?v=18">๐ ะขะฐะฑะปะพ</a>
  </nav>
</main>

<script>
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) { tg.expand(); tg.ready(); }
  function isInsideTelegram(){ try { return !!(tg && tg.initDataUnsafe && tg.platform); } catch(e){ return false; } }

  const coinsFrom = document.getElementById('coinsFrom');
  const coinsTo   = document.getElementById('coinsTo');
  const amt       = document.getElementById('amount');
  const res       = document.getElementById('result');
  const hint      = document.getElementById('hint');

  const ICON_CLASS = {
    USD:"usd", USDT:"usdt", CNY:"cny", BTC:"btc", ETH:"eth", XMR:"xmr", RUB:"rub"
  };

  let FROM = "USDT";
  let TO   = "RUB";

  function coinTile(code){
    const div = document.createElement('div');
    div.className = 'coin';
    div.dataset.code = code;
    const ic = document.createElement('span');
    ic.className = 'icon ' + (ICON_CLASS[code]||'');
    const cap = document.createElement('div');
    cap.className = 'cap';
    cap.textContent = code;
    div.append(ic, cap);
    return div;
  }

  function renderCoins(){
    coinsFrom.innerHTML = '';
    coinsTo.innerHTML   = '';

    CURRENCIES.forEach(c=>{
      const t1 = coinTile(c.code);
      if (c.code === FROM) t1.classList.add('active');
      t1.onclick = ()=>{ FROM=c.code; if (TO===FROM){ // ะฒัะฑะตัะตะผ ะดััะณะพะน TO
        TO = (CURRENCIES.find(x=>x.code!=="RUB" && x.code!==FROM)?.code) || "RUB";
      } renderCoins(); recalc(); };
      coinsFrom.appendChild(t1);

      const t2 = coinTile(c.code);
      if (c.code === TO) t2.classList.add('active');
      if (c.code === FROM) { t2.style.opacity=.4; t2.style.pointerEvents='none'; }
      t2.onclick = ()=>{ TO=c.code; if (TO===FROM){ FROM="RUB"; } renderCoins(); recalc(); };
      coinsTo.appendChild(t2);
    });
  }

  function recalc(){
    const a = parseFloat(amt.value||'0');
    const q = quotePair(FROM, TO, a);
    if (!q){ res.textContent='ะััั: โ | ะ ะฟะพะปััะตะฝะธั: โ'; return null; }
    res.textContent = `ะััั: ${q.rate.toFixed(6)} | ะ ะฟะพะปััะตะฝะธั: ${formatN(q.total)}`;
    return { from: FROM, to: TO, a, rate:q.rate, total:q.total };
  }

  amt.oninput = recalc;
  renderCoins(); recalc();

  if (!isInsideTelegram()) hint.hidden = false;

  // ะัะฟัะฐะฒะบะฐ ะทะฐัะฒะบะธ ัะตัะตะท tg.sendData (ะบะฐะบ ัะฐะฝััะต)
  document.getElementById('sendBtn').onclick = ()=>{
    const r = recalc(); if(!r){ alert('ะะฒะตะดะธัะต ััะผะผั'); return; }
    const payload = {
      action: 'request',
      direction: `${r.from}>${r.to}`,
      amount: r.a,
      contact: (document.getElementById('contact').value || '').trim(),
      requisites: (document.getElementById('requisites').value || '').trim(),
      note: (document.getElementById('note').value || '').trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };
    if (isInsideTelegram()){
      try{
        tg.HapticFeedback?.impactOccurred('medium');
        tg.showPopup?.({ title: 'ะัะฟัะฐะฒะบะฐ', message: 'ะะฐัะฒะบะฐ ะพัะฟัะฐะฒะปัะตัััโฆ' });
        tg.sendData(JSON.stringify(payload));
        tg.close();
      }catch(e){
        console.error(e);
        alert('ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ัะตัะตะท Telegram. ะะพะฟัะพะฑัะนัะต ะตัั ัะฐะท.');
      }
    } else {
      alert('ะัะบัะพะนัะต ััั ัััะฐะฝะธัั ะธะท ะบะฝะพะฟะบะธ ะฑะพัะฐ ะฒ Telegram, ััะพะฑั ะพัะฟัะฐะฒะธัั ะทะฐัะฒะบั.');
    }
  };

  // ยซะถะธะฒะพะนยป ัะพะฝ
  document.addEventListener('scroll', () => {
    const y = window.scrollY || 0;
    document.body.style.setProperty('--bg-shift', (y * 0.03).toFixed(2) + 'px');
  }, {passive:true});
</script>
</body>
</html>
