<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css?v=5" />
  <script src="./pricing.js?v=5"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header>
  <img src="./assets/logo.png" class="logo" alt="Poiz Exchange">
  <div class="currency-strip">üá∑üá∫ ‚ÇΩ ¬∑ üá®üá≥ ¬• ¬∑ üá∫üá∏ $ ¬∑ üí≤ USDT</div>
</header>

<main>
  <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞</h2>

  <label>–û—Ç–¥–∞—é</label>
  <select id="from"></select>

  <label>–ü–æ–ª—É—á–∞—é</label>
  <select id="to"></select>

  <div id="rubcnyModeBox" style="display:none; gap:10px; margin-top:8px">
    <button id="modeByY" class="btn-ghost">RUB‚ÜíCNY –ø–æ ¬•</button>
    <button id="modeFix10" class="btn-ghost">RUB‚ÜíCNY —Ñ–∏–∫—Å 10</button>
  </div>

  <label>–°—É–º–º–∞</label>
  <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" />

  <div id="result" class="result">–ö—É—Ä—Å: ‚Äî | –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ‚Äî</div>

  <h2>–ó–∞—è–≤–∫–∞</h2>

  <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
  <input id="contact" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" />

  <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
  <textarea id="requisites" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/–∫–æ—à–µ–ª—å–∫–∞, –±–∞–Ω–∫, –§–ò–û"></textarea>

  <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
  <textarea id="note" placeholder="–ì–æ—Ä–æ–¥, –±–∞–Ω–∫, —Å—Ä–æ—á–Ω–æ—Å—Ç—å‚Ä¶"></textarea>

  <label>QR-—Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
  <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />

  <button id="sendBtn">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
</main>

<footer>
  <a href="https://t.me/poizchat" target="_blank">üí¨ –ß–∞—Ç</a>
  <a href="https://t.me/poizmanager" target="_blank">üìû –ê–¥–º–∏–Ω</a>
  <a href="./rates.html?v=5">üìä –¢–∞–±–ª–æ</a>
</footer>

<script>
  // --- Telegram WebApp init ---
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) { tg.expand(); tg.ready(); }

  // --- –í–∞–ª—é—Ç—ã –∏–∑ pricing.js ---
  // CURRENCIES –∏ —Ñ—É–Ω–∫—Ü–∏–∏ quote/buildDirection/formatN/pickTariff –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ pricing.js

  // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
  const selFrom = document.getElementById('from');
  const selTo   = document.getElementById('to');
  CURRENCIES.forEach(c => {
    selFrom.add(new Option(c.title, c.code));
    selTo.add(new Option(c.title, c.code));
  });

  // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ URL (?from=&to=) –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
  const qs = new URLSearchParams(location.search);
  selFrom.value = qs.get('from') || 'USDT';
  selTo.value   = qs.get('to')   || 'RUB';

  // –†–µ–∂–∏–º RUB‚ÜíCNY: –ø–æ ¬• –∏–ª–∏ —Ñ–∏–∫—Å 10
  let rubCnyMode = 'byy';
  const modeBox  = document.getElementById('rubcnyModeBox');
  const btnByY   = document.getElementById('modeByY');
  const btnFix   = document.getElementById('modeFix10');

  const amt = document.getElementById('amount');
  const res = document.getElementById('result');

  function updateMode(){
    modeBox.style.display = (selFrom.value === 'RUB' && selTo.value === 'CNY') ? 'flex' : 'none';
  }

  function recalc(){
    updateMode();
    const dir = buildDirection(selFrom.value, selTo.value, rubCnyMode);
    const a   = parseFloat(amt.value || '0');
    const q   = quote(dir, a);
    if (!q) { res.textContent = '–ö—É—Ä—Å: ‚Äî | –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ‚Äî'; return null; }
    res.textContent = `–ö—É—Ä—Å: ${q.rate} | –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ${formatN(q.total)}`;
    return { dir, a, rate: q.rate, total: q.total };
  }

  btnByY.onclick = () => { rubCnyMode = 'byy'; recalc(); };
  btnFix.onclick = () => { rubCnyMode = 'fix'; recalc(); };

  selFrom.onchange = recalc;
  selTo.onchange   = recalc;
  amt.oninput      = recalc;
  recalc();

  // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –≤ –±–æ—Ç–∞ ---
  function isInsideTelegram(){
    try { return !!(tg && tg.initDataUnsafe && tg.platform); } catch(e){ return false; }
  }

  function buildPayload(){
    const r = recalc(); // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã
    return {
      action: 'request',
      direction: r ? r.dir : '',
      amount:    r ? r.a   : 0,
      contact:    (document.getElementById('contact').value    || '').trim(),
      requisites: (document.getElementById('requisites').value || '').trim(),
      note:       (document.getElementById('note').value       || '').trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };
  }

  async function sendRequest(){
    const payload = buildPayload();
    if (!isInsideTelegram()){
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ Telegram, –∞ –Ω–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
      return;
    }
    try{
      tg.HapticFeedback && tg.HapticFeedback.impactOccurred('medium');
      tg.showPopup && tg.showPopup({ title: '–û—Ç–ø—Ä–∞–≤–∫–∞', message: '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è‚Ä¶' });
      tg.sendData(JSON.stringify(payload));
      tg.close();
    }catch(e){
      console.error(e);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ @poizmanager');
    }
  }

  // –ö–Ω–æ–ø–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  document.getElementById('sendBtn').onclick = sendRequest;

  // Telegram MainButton (–Ω–∏–∑ —ç–∫—Ä–∞–Ω–∞)
  if (tg && tg.MainButton){
    tg.MainButton.setText('üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
    tg.MainButton.show();
    tg.onEvent('mainButtonClicked', sendRequest);
  }
</script>
</body>
</html>
