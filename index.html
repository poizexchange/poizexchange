<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange โ ะะฐะปัะบัะปััะพั</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://telegram.org">
  <link rel="stylesheet" href="./styles.css?v=22" />
  <script src="./pricing.js?v=22"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header class="header">
  <div class="brand-strip">
    <span>๐ท๐บ โฝ</span><span>ยท</span><span>๐จ๐ณ ยฅ</span><span>ยท</span><span>๐บ๐ธ $</span><span>ยท</span><span>๐ฒ USDT</span>
  </div>
</header>

<main class="container">
  <section class="card">
    <h1 class="title">ะะฐะปัะบัะปััะพั ะพะฑะผะตะฝะฐ</h1>

    <!-- ะจะะ 1 ยท ะะขะะะฎ -->
    <div class="step-caption">ะจะฐะณ 1 ยท ะั ะพัะดะฐััะต</div>

    <div class="paytypes" id="payFrom">
      <button class="pay btn-tile" data-type="cash">๐ต ะะฐะปะธัะฝัะต</button>
      <button class="pay btn-tile" data-type="bank">๐ฆ ะะฐะฝะบะพะฒัะบะธะน ะฟะตัะตะฒะพะด</button>
      <button class="pay btn-tile" data-type="crypto">๐ช ะัะธะฟัะพะฒะฐะปััะฐ</button>
    </div>

    <div class="grid2">
      <div>
        <label>ะะพัะพะด (ะตัะปะธ ะฝะฐะปะธัะฝัะต)</label>
        <select id="cityFrom">
          <option value="">โ ะฝะต ะฒัะฑัะฐะฝะพ โ</option>
          <option value="moscow">ะะพัะบะฒะฐ</option>
          <option value="guangzhou">ะัะฐะฝัะถะพั</option>
        </select>
      </div>
    </div>

    <div id="coinsFrom" class="coins"></div>

    <!-- ะจะะ 2 ยท ะะะะฃะงะะฎ -->
    <div class="step-caption">ะจะฐะณ 2 ยท ะั ะฟะพะปััะฐะตัะต</div>

    <div class="paytypes" id="payTo">
      <button class="pay btn-tile" data-type="cash">๐ต ะะฐะปะธัะฝัะต</button>
      <button class="pay btn-tile" data-type="bank">๐ฆ ะะฐะฝะบะพะฒัะบะธะน ะฟะตัะตะฒะพะด</button>
      <button class="pay btn-tile" data-type="crypto">๐ช ะัะธะฟัะพะฒะฐะปััะฐ</button>
    </div>

    <div class="grid2">
      <div>
        <label>ะะพัะพะด (ะตัะปะธ ะฝะฐะปะธัะฝัะต)</label>
        <select id="cityTo">
          <option value="">โ ะฝะต ะฒัะฑัะฐะฝะพ โ</option>
          <option value="moscow">ะะพัะบะฒะฐ</option>
          <option value="guangzhou">ะัะฐะฝัะถะพั</option>
        </select>
      </div>
    </div>

    <div id="coinsTo" class="coins"></div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>ะกัะผะผะฐ</label>
        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" inputmode="decimal" />
      </div>
      <div>
        <label>ะััั/ะัะพะณ</label>
        <div id="result" class="resultBox">ะััั: โ | ะ ะฟะพะปััะตะฝะธั: โ</div>
      </div>
    </div>

    <div class="divider"></div>

    <h2 class="subtitle">ะะฐัะฒะบะฐ</h2>
    <div class="grid2">
      <div>
        <label>ะะพะฝัะฐะบั</label>
        <input id="contact" placeholder="@username ะธะปะธ ัะตะปะตัะพะฝ" />
      </div>
      <div>
        <label>QR-ัะฐะนะป (ะพะฟัะธะพะฝะฐะปัะฝะพ)</label>
        <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />
      </div>
    </div>

    <label>ะะตะบะฒะธะทะธัั</label>
    <textarea id="requisites" placeholder="ะะพะผะตั ะบะฐััั/ะบะพัะตะปัะบะฐ, ะฑะฐะฝะบ, ะคะะ"></textarea>

    <label>ะะพะผะผะตะฝัะฐัะธะน</label>
    <textarea id="note" placeholder="ะะพัะพะด, ะฑะฐะฝะบ, ััะพัะฝะพัััโฆ"></textarea>

    <button id="sendBtn" class="btn-primary">๐ฉ ะัะฟัะฐะฒะธัั ะทะฐัะฒะบั</button>
    <p id="hint" class="hint" hidden>ะัะบัะพะนัะต ัะพัะผั ัะตัะตะท ะบะฝะพะฟะบั ะฒ Telegram, ััะพะฑั ะพัะฟัะฐะฒะธัั ะทะฐัะฒะบั ะฝะฐะฟััะผัั ะฑะพัั.</p>
  </section>

  <nav class="actions">
    <a class="link" href="https://t.me/poizchat" target="_blank">๐ฌ ะงะฐั</a>
    <a class="link" href="https://t.me/poizmanager" target="_blank">๐ ะะดะผะธะฝ</a>
    <a class="link" href="./rates.html?v=22">๐ ะขะฐะฑะปะพ</a>
  </nav>
</main>

<script>
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) { tg.expand(); tg.ready(); }
  function isInsideTelegram(){ try { return !!(tg && tg.initDataUnsafe && tg.platform); } catch(e){ return false; } }

  // ะธะบะพะฝะบะธ-ัะฐะนะปั (ะตัะปะธ ะธัะฟะพะปัะทัะตัั ะฟะฐะฟะบั /icons)
  const ICON_SRC = {
    USD: "./icons/usd.svg",
    USDT:"./icons/usdt.svg",
    CNY: "./icons/cny.svg",
    BTC: "./icons/btc.svg",
    ETH: "./icons/eth.svg",
    XMR: "./icons/xmr.svg",
    RUB: "./icons/rub.svg",
  };

  // ะฑะฐะทั ะฒะฐะปัั
  const ALL_CODES = ["USD","USDT","CNY","BTC","ETH","XMR","RUB"];

  // ะฒัะฑะพัะบะธ ะฟะพ ัะธะฟั ะพะฟะปะฐัั
  const PAYMENT_COINS_FROM = {
    cash:  ["RUB","USD"],                // ะฝะฐะปะธัะฝัะต: ัะฐะฝะธ ะะขะะะขะฌ ะฝะตะปัะทั
    bank:  ["RUB","USD","CNY"],
    crypto:["USDT","BTC","ETH","XMR"],
  };
  const PAYMENT_COINS_TO = {
    cash:  ["RUB","USD","CNY"],          // ะฝะฐะปะธัะฝัะต: CNY ะผะพะถะฝะพ ะะะะฃะงะะขะฌ ัะพะปัะบะพ ะฒ ะัะฐะฝัะถะพั (ะฟัะพะฒะตัะธะผ ะฝะธะถะต)
    bank:  ["RUB","USD","CNY"],
    crypto:["USDT","BTC","ETH","XMR"],
  };

  // ะฟะพะดะฟะธัะธ ะดะปั ะฝะฐะปะธัะฝัั
  const CASH_LABEL = { RUB: "ะัะฑะปั RUB", USD: "ะะพะปะปะฐั (ะฝะพะฒัะต) USD", CNY: "ะฎะฐะฝั CNY" };

  // DOM
  const payFrom = document.getElementById('payFrom');
  const payTo   = document.getElementById('payTo');
  const cityFrom= document.getElementById('cityFrom');
  const cityTo  = document.getElementById('cityTo');

  const coinsFrom = document.getElementById('coinsFrom');
  const coinsTo   = document.getElementById('coinsTo');
  const amt       = document.getElementById('amount');
  const res       = document.getElementById('result');
  const hint      = document.getElementById('hint');

  // state
  let PAYMENT_FROM = null; // 'cash' | 'bank' | 'crypto'
  let PAYMENT_TO   = null;
  let CITY_FROM    = "";
  let CITY_TO      = "";

  let FROM = "USDT";
  let TO   = "RUB";

  function coinCaption(code, sectionPayment){
    if (sectionPayment === 'cash' && CASH_LABEL[code]) return CASH_LABEL[code];
    return code;
  }

  function coinTile(code, sectionPayment){
    const div = document.createElement('div');
    div.className = 'coin';
    div.dataset.code = code;

    const img = document.createElement('img');
    img.className = 'iconimg';
    img.alt = code;
    img.src = ICON_SRC[code] || '';

    const cap = document.createElement('div');
    cap.className = 'cap';
    cap.textContent = coinCaption(code, sectionPayment);

    div.append(img, cap);
    return div;
  }

  function renderCoins(){
    // FROM
    coinsFrom.innerHTML = '';
    let fromList = PAYMENT_FROM ? PAYMENT_COINS_FROM[PAYMENT_FROM] : [];
    fromList.forEach(code=>{
      const t1 = coinTile(code, PAYMENT_FROM);
      if (code === FROM) t1.classList.add('active');
      t1.onclick = ()=>{
        FROM = code;
        if (TO === FROM){
          // ะฟะพะดะพะฑัะฐัั ะฐะปััะตัะฝะฐัะธะฒั ะฒ ัะฟะธัะบะต TO
          let toList = PAYMENT_TO ? PAYMENT_COINS_TO[PAYMENT_TO] : ALL_CODES;
          toList = filterToByCity(toList); // ััะตััั ะพะณัะฐะฝะธัะตะฝะธะต CNY/ะัะฐะฝัะถะพั
          const alt = toList.find(x=>x!==FROM);
          if (alt) TO = alt;
        }
        renderCoins(); recalc();
      };
      coinsFrom.appendChild(t1);
    });

    // TO
    coinsTo.innerHTML = '';
    let toList = PAYMENT_TO ? PAYMENT_COINS_TO[PAYMENT_TO] : [];
    toList = filterToByCity(toList); // ััะตััั CNY/ะัะฐะฝัะถะพั
    toList.forEach(code=>{
      const t2 = coinTile(code, PAYMENT_TO);
      if (code === TO) t2.classList.add('active');
      if (code === FROM) { t2.style.opacity=.4; t2.style.pointerEvents='none'; }
      t2.onclick = ()=>{
        TO = code;
        if (TO === FROM){
          // ะฟะพะดะพะฑัะฐัั ะฐะปััะตัะฝะฐัะธะฒั
          const alt = toList.find(x=>x!==FROM);
          if (alt) TO = alt;
        }
        renderCoins(); recalc();
      };
      coinsTo.appendChild(t2);
    });
  }

  function filterToByCity(list){
    // ยซะฝะฐะปะธัะฝัะต ัะฐะฝะธ ะฟะพะปััะธัั ะผะพะถะฝะพ ัะพะปัะบะพ ะฒ ะัะฐะฝัะถะพัยป
    if (PAYMENT_TO === 'cash'){
      return list.filter(code=>{
        if (code !== 'CNY') return true;
        return CITY_TO === 'guangzhou'; // CNY ะฝะฐะปะธัะฝัะผะธ โ ัะพะปัะบะพ ะัะฐะฝัะถะพั
      });
    }
    return list;
  }

  function recalc(){
    const a = parseFloat(amt.value||'0');
    const q = quotePair(FROM, TO, a);
    if (!q){ res.textContent='ะััั: โ | ะ ะฟะพะปััะตะฝะธั: โ'; return null; }
    res.textContent = `ะััั: ${q.rate.toFixed(6)} | ะ ะฟะพะปััะตะฝะธั: ${formatN(q.total)}`;
    return { from: FROM, to: TO, a, rate:q.rate, total:q.total };
  }

  function bindPayGroup(root, setter, isFrom){
    root.querySelectorAll('.pay').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        root.querySelectorAll('.pay').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        setter(btn.dataset.type);

        // ะฟัะธ ะฒัะฑะพัะต ะฝะฐะปะธัะฝัั โ ะฒะบะปััะฐะตะผ ะฒัะฑะพั ะณะพัะพะดะฐ; ะธะฝะฐัะต ัะฑัะฐััะฒะฐะตะผ
        const citySel = isFrom ? cityFrom : cityTo;
        if (btn.dataset.type === 'cash'){
          citySel.disabled = false;
        } else {
          citySel.value = ""; // ัะฑัะพั
          citySel.disabled = true;
          if (isFrom) CITY_FROM = "";
          else CITY_TO = "";
        }

        // ะฟะตัะตะพััะธัะพะฒะฐัั ะฒะฐะปััั
        renderCoins(); recalc();
      });
    });
  }
  bindPayGroup(payFrom, (t)=>{ PAYMENT_FROM = t; }, true);
  bindPayGroup(payTo,   (t)=>{ PAYMENT_TO   = t; }, false);

  // ะณะพัะพะดะฐ
  cityFrom.addEventListener('change', ()=>{
    CITY_FROM = cityFrom.value;
    renderCoins(); recalc();
  });
  cityTo.addEventListener('change', ()=>{
    CITY_TO = cityTo.value;
    renderCoins(); recalc();
  });

  // init
  // ะฟะพ ัะผะพะปัะฐะฝะธั ะฟะพััะฐะฒะธะผ ัะธะฟั (ะผะพะถะฝะพ ะฟะพะผะตะฝััั)
  PAYMENT_FROM = 'crypto';  payFrom.querySelector('[data-type="crypto"]').classList.add('active');
  cityFrom.disabled = true;

  PAYMENT_TO = 'cash';      payTo.querySelector('[data-type="cash"]').classList.add('active');
  cityTo.disabled = false;

  // ะดะตัะพะปัะฝัะต ะฒะฐะปััั ะฟะพะดััะฐะฒะธะผ ะฟะพะด ะฒัะฑัะฐะฝะฝัะต ัะธะฟั
  FROM = 'USDT';
  TO   = 'RUB';

  renderCoins(); recalc();

  if (!isInsideTelegram()) hint.hidden = false;

  // ะพัะฟัะฐะฒะบะฐ ะทะฐัะฒะบะธ
  document.getElementById('sendBtn').onclick = ()=>{
    const r = recalc(); if(!r){ alert('ะะฒะตะดะธัะต ััะผะผั'); return; }
    if (!PAYMENT_FROM || !PAYMENT_TO){
      alert('ะัะฑะตัะธัะต ัะธะฟ ะพะฟะปะฐัั ะดะปั ยซะัะดะฐััะตยป ะธ ยซะะพะปััะฐะตัะตยป.');
      return;
    }
    if (PAYMENT_FROM === 'cash' && !CITY_FROM){
      alert('ะัะฑะตัะธัะต ะณะพัะพะด ะดะปั ยซะัะดะฐััะต (ะฝะฐะปะธัะฝัะต)ยป.');
      return;
    }
    if (PAYMENT_TO === 'cash' && !CITY_TO){
      alert('ะัะฑะตัะธัะต ะณะพัะพะด ะดะปั ยซะะพะปััะฐะตัะต (ะฝะฐะปะธัะฝัะต)ยป.');
      return;
    }

    const payload = {
      action: 'request',
      payment_from: PAYMENT_FROM,
      payment_to:   PAYMENT_TO,
      city_from:    CITY_FROM || null,
      city_to:      CITY_TO   || null,
      direction: `${r.from}>${r.to}`,
      amount: r.a,
      contact: (document.getElementById('contact').value || '').trim(),
      requisites: (document.getElementById('requisites').value || '').trim(),
      note: (document.getElementById('note').value || '').trim(),
      has_qr: !!document.getElementById('qrfile').files?.length,
      qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
    };

    if (isInsideTelegram()){
      try{
        tg.HapticFeedback?.impactOccurred('medium');
        tg.showPopup?.({ title: 'ะัะฟัะฐะฒะบะฐ', message: 'ะะฐัะฒะบะฐ ะพัะฟัะฐะฒะปัะตัััโฆ' });
        tg.sendData(JSON.stringify(payload));
        tg.close();
      }catch(e){
        console.error(e);
        alert('ะัะธะฑะบะฐ ะพัะฟัะฐะฒะบะธ ัะตัะตะท Telegram. ะะพะฟัะพะฑัะนัะต ะตัั ัะฐะท.');
      }
    } else {
      alert('ะัะบัะพะนัะต ััั ัััะฐะฝะธัั ะธะท ะบะฝะพะฟะบะธ ะฑะพัะฐ ะฒ Telegram, ััะพะฑั ะพัะฟัะฐะฒะธัั ะทะฐัะฒะบั.');
    }
  };

  // ยซะถะธะฒะพะนยป ัะพะฝ
  document.addEventListener('scroll', () => {
    const y = window.scrollY || 0;
    document.body.style.setProperty('--bg-shift', (y * 0.03).toFixed(2) + 'px');
  }, {passive:true});
</script>
</body>
</html>
