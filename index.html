<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="stylesheet" href="./styles.css?v=34b" />
  <script src="./pricing.js?v=34b"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">Poiz Exchange</div>
      <div class="strip">üá∑üá∫ ‚ÇΩ ¬∑ üá®üá≥ ¬• ¬∑ üá∫üá∏ $ ¬∑ üí≤ USDT ¬∑ ‚Çø BTC ¬∑ Œû ETH ¬∑ …± XMR</div>
    </header>

    <main class="app-main">
      <h1 class="title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞</h1>

      <section class="card">
        <div class="section-title">–û—Ç–¥–∞—é</div>
        <div id="fromGrid" class="currency-grid"></div>

        <div class="section-title">–ü–æ–ª—É—á–∞—é</div>
        <div id="toGrid" class="currency-grid"></div>

        <!-- —Å–ø–µ—Ü-—Ä–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è RUB‚ÜíCNY -->
        <div id="rubcnyModeBox" class="mode-box" hidden>
          <button id="modeByY" class="btn ghost">RUB‚ÜíCNY –ø–æ ¬•</button>
          <button id="modeFix10" class="btn ghost">RUB‚ÜíCNY —Ñ–∏–∫—Å 10</button>
        </div>

        <div class="row gap">
          <div class="col">
            <label class="label">–°—É–º–º–∞</label>
            <input type="number" id="amount" class="input" placeholder="0.00" min="0" step="0.01"/>
          </div>
          <div class="col">
            <label class="label">&nbsp;</label>
            <button id="recalcBtn" class="btn primary w100">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
          </div>
        </div>

        <div id="result" class="result">
          <div class="result-line">
            <span>–ö—É—Ä—Å</span><strong id="rateVal">‚Äî</strong>
          </div>
          <div class="result-line">
            <span>–ö –ø–æ–ª—É—á–µ–Ω–∏—é</span><strong id="totalVal">‚Äî</strong>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">–ó–∞—è–≤–∫–∞</div>

        <label class="label">–ö–æ–Ω—Ç–∞–∫—Ç</label>
        <input id="contact" class="input" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"/>

        <label class="label">–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
        <textarea id="requisites" class="input textarea" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/–∫–æ—à–µ–ª—å–∫–∞, –±–∞–Ω–∫, –§–ò–û"></textarea>

        <label class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="note" class="input textarea" placeholder="–ì–æ—Ä–æ–¥, –±–∞–Ω–∫, —Å—Ä–æ—á–Ω–æ—Å—Ç—å‚Ä¶"></textarea>

        <div id="qrRow" class="qr-row" hidden>
          <label class="label">QR-—Ñ–∞–π–ª (–¥–ª—è Alipay/WeChat/–±–∞–Ω–∫–æ–≤ –ö–∏—Ç–∞—è)</label>
          <input type="file" id="qrfile" class="input" accept="image/*,.png,.jpg,.jpeg,.webp"/>
        </div>

        <button id="sendBtn" class="btn primary w100">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      </section>

      <div class="links">
        <a class="link" href="https://t.me/poizchat" target="_blank">üí¨ –ß–∞—Ç</a>
        <a class="link" href="https://t.me/poizmanager" target="_blank">üìû –ê–¥–º–∏–Ω</a>
        <a class="link" href="./rates.html?v=34b">üìä –¢–∞–±–ª–æ –∫—É—Ä—Å–æ–≤</a>
      </div>
    </main>
  </div>

  <script>
    const tg = window.Telegram?.WebApp || null;
    if (tg) { tg.expand(); tg.ready(); }

    const fromGrid = document.getElementById('fromGrid');
    const toGrid   = document.getElementById('toGrid');
    const amountEl = document.getElementById('amount');
    const rateVal  = document.getElementById('rateVal');
    const totalVal = document.getElementById('totalVal');
    const modeBox  = document.getElementById('rubcnyModeBox');
    const btnByY   = document.getElementById('modeByY');
    const btnFix   = document.getElementById('modeFix10');
    const qrRow    = document.getElementById('qrRow');

    let rubCnyMode = 'byy';
    let fromCode = 'USDT';
    let toCode   = 'RUB';

    function buildItem(c) {
      const b = document.createElement('button');
      b.className = 'pill';
      b.textContent = c.title;
      b.dataset.code = c.code;
      return b;
    }

    function renderGrid(grid, list, selected, onPick) {
      grid.innerHTML = '';
      list.forEach(c => {
        const btn = buildItem(c);
        if (c.code === selected) btn.classList.add('active');
        btn.addEventListener('click', () => {
          grid.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          onPick(c.code);
          recalc();
        });
        grid.appendChild(btn);
      });
    }

    function currencies() {
      return Array.isArray(window.CURRENCIES) && window.CURRENCIES.length
        ? window.CURRENCIES
        : [
          { code: "USDT", title: "üí≤ USDT" },
          { code: "USD",  title: "üá∫üá∏ USD" },
          { code: "RUB",  title: "üá∑üá∫ RUB" },
          { code: "CNY",  title: "üá®üá≥ CNY" },
          { code: "BTC",  title: "‚Çø BTC"  },
          { code: "ETH",  title: "Œû ETH"  },
          { code: "XMR",  title: "…± XMR"  },
        ];
    }

    function updateModeAndQR() {
      // —Ä–µ–∂–∏–º RUB‚ÜíCNY
      const rub2cny = fromCode === 'RUB' && toCode === 'CNY';
      modeBox.hidden = !rub2cny;

      // –ø–æ–∫–∞–∑ –ø–æ–ª—è QR —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—É—á–∞–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ª–æ–≥–∏–∫–∞ –¥–ª—è —Ç–≤–æ–µ–π –±—É–¥—É—â–µ–π –º–∞—Ç—Ä–∏—Ü—ã)
      const cnReceive = (toCode === 'CNY');
      qrRow.hidden = !cnReceive;
    }

    function buildDirectionLocal(from, to, mode) {
      return (typeof window.buildDirection === 'function')
        ? window.buildDirection(from, to, mode)
        : `${from}>${to}`;
    }

    function recalc() {
      updateModeAndQR();
      const a = parseFloat(amountEl.value || '0');
      const dir = buildDirectionLocal(fromCode, toCode, rubCnyMode);
      const q = (typeof window.quote === 'function') ? window.quote(dir, a) : {rate: 0, total: 0};
      rateVal.textContent  = q.rate ?? '‚Äî';
      totalVal.textContent = (q.total != null) ? q.total : '‚Äî';
      window._lastQuote = {dir, a, ...q};
      return q;
    }

    // init
    const list = currencies();
    renderGrid(fromGrid, list, fromCode, (code)=> fromCode = code);
    renderGrid(toGrid,   list, toCode,   (code)=> toCode   = code);
    amountEl.addEventListener('input', recalc);
    document.getElementById('recalcBtn').addEventListener('click', recalc);

    btnByY.addEventListener('click', ()=>{ rubCnyMode='byy'; recalc(); });
    btnFix.addEventListener('click', ()=>{ rubCnyMode='fix'; recalc(); });

    recalc();

    function sendRequest() {
      const q = recalc();
      const payload = {
        action: 'request',
        direction: window._lastQuote?.dir || (fromCode + '>' + toCode),
        from_currency: fromCode,
        to_currency: toCode,
        amount: window._lastQuote?.a ?? 0,
        rate: q?.rate ?? 0,
        total: q?.total ?? 0,
        contact: document.getElementById('contact').value.trim(),
        requisites: document.getElementById('requisites').value.trim(),
        note: document.getElementById('note').value.trim(),
        has_qr: !!document.getElementById('qrfile').files?.length,
        qr_filename: document.getElementById('qrfile').files?.[0]?.name || null
      };
      if (!tg) { alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –≤–Ω—É—Ç—Ä–∏ Telegram'); return; }
      try {
        tg.HapticFeedback?.impactOccurred('medium');
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } catch (e) {
        console.error(e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ù–∞–ø–∏—à–∏—Ç–µ @poizmanager');
      }
    }
    document.getElementById('sendBtn').addEventListener('click', sendRequest);

    if (tg?.MainButton) {
      tg.MainButton.setText('üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
      tg.MainButton.show();
      tg.onEvent('mainButtonClicked', sendRequest);
    }
  </script>
</body>
</html>
