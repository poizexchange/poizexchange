<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
  <link rel="stylesheet" href="./styles.css?v=34" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="./pricing.js?v=34"></script>
  <script src="./index.js?v=34" defer></script>
</head>
<body class="tg-white">
  <header class="tg-header">
    <div class="wrap">
      <h1 class="title">–ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –û–ë–ú–ï–ù–ê</h1>
    </div>
  </header>

  <main class="wrap main-safe">
    <section class="card">
      <h2 class="h2">–û—Ç–¥–∞—é</h2>
      <div class="chips" id="from-pay">
        <button class="chip" data-type="cash"><img src="./icons/cash.svg" alt="">–ù–∞–ª–∏—á–Ω—ã–µ</button>
        <button class="chip" data-type="bank"><img src="./icons/bank.svg" alt="">–ë–∞–Ω–∫</button>
        <button class="chip" data-type="crypto"><img src="./icons/crypto.svg" alt="">–ö—Ä–∏–ø—Ç–æ</button>
      </div>

      <div id="from-citybox" class="citybox" hidden>
        <label class="label" for="cityFrom">–ì–æ—Ä–æ–¥</label>
        <select id="cityFrom" class="input">
          <option value="moscow">–ú–æ—Å–∫–≤–∞</option>
          <option value="guangzhou">–ì—É–∞–Ω—á–∂–æ—É</option>
        </select>
      </div>

      <div id="from-currencies" class="tiles"></div>
    </section>

    <section class="card">
      <h2 class="h2">–ü–æ–ª—É—á–∞—é</h2>
      <div class="chips wrap" id="to-pay">
        <button class="chip" data-type="cash"><img src="./icons/cash.svg" alt="">–ù–∞–ª–∏—á–Ω—ã–µ</button>
        <button class="chip" data-type="bank"><img src="./icons/bank.svg" alt="">–ë–∞–Ω–∫</button>
        <button class="chip" data-type="crypto"><img src="./icons/crypto.svg" alt="">–ö—Ä–∏–ø—Ç–æ</button>
        <button class="chip full" data-type="cnpay"><img src="./icons/bankcn.svg" alt="">–ö–∏—Ç–∞–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã</button>
      </div>

      <div id="to-citybox" class="citybox" hidden>
        <label class="label" for="cityTo">–ì–æ—Ä–æ–¥</label>
        <select id="cityTo" class="input">
          <option value="moscow">–ú–æ—Å–∫–≤–∞</option>
          <option value="guangzhou">–ì—É–∞–Ω—á–∂–æ—É</option>
        </select>
      </div>

      <div id="to-currencies" class="tiles"></div>
    </section>

    <section class="card">
      <div class="calc-grid">
        <div>
          <label class="label" for="amount">–°—É–º–º–∞</label>
        <input id="amount" type="number" inputmode="decimal" step="0.01" min="0" class="input" placeholder="0.00" />
        </div>
        <div class="result-card">
          <div class="result-line">
            <div class="r-cap">–ö—É—Ä—Å</div>
            <div id="rateVal" class="r-val">‚Äî</div>
          </div>
          <div class="result-line">
            <div class="r-cap">–ö –ø–æ–ª—É—á–µ–Ω–∏—é</div>
            <div id="totalVal" class="r-big">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="h2">–ó–∞—è–≤–∫–∞</h2>
      <label class="label" for="contact">–ö–æ–Ω—Ç–∞–∫—Ç</label>
      <input id="contact" class="input" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" />

      <label class="label" for="requisites">–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
      <textarea id="requisites" class="input" rows="3" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/–∫–æ—à–µ–ª—å–∫–∞, –±–∞–Ω–∫, –§–ò–û"></textarea>

      <label class="label" for="note">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="note" class="input" rows="3" placeholder="–î–µ—Ç–∞–ª–∏, —Å—Ä–æ—á–Ω–æ—Å—Ç—å‚Ä¶"></textarea>

      <div id="qrbox" class="qrbox" hidden>
        <label class="label" for="qrfile">–ü—Ä–∏—à–ª–∏—Ç–µ QR-–∫–æ–¥ (–¥–ª—è Alipay / WeChat / –∫–∞—Ä—Ç–∞ –ö–∏—Ç–∞—è)</label>
        <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" class="input-file">
      </div>

      <button id="sendBtn" class="btn-primary">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      <p id="hint" class="hint" hidden>–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –∏–∑ –±–æ—Ç–∞ –≤ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é.</p>
    </section>

    <nav class="footlinks">
      <a href="./rates.html?v=34">üìä –¢–∞–±–ª–æ</a>
      <a href="https://t.me/poizchat" target="_blank">üí¨ –ß–∞—Ç</a>
      <a href="https://t.me/poizmanager" target="_blank">üìû –ê–¥–º–∏–Ω</a>
    </nav>
  </main>
<script>
  // –ñ–¥—ë–º, –ø–æ–∫–∞ DOM –≥–æ—Ç–æ–≤
  document.addEventListener('DOMContentLoaded', () => {
    // Telegram WebApp API
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const amountInput = document.getElementById('amount');
    const contactInput = document.getElementById('contact');
    const requisitesInput = document.getElementById('requisites');
    const noteInput = document.getElementById('note');
    const sendBtn = document.getElementById('sendBtn');

    // –ï—Å–ª–∏ —É —Ç–µ–±—è —Å–µ–ª–µ–∫—Ç—ã:
    const selFrom = document.getElementById('from');
    const selTo   = document.getElementById('to');

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ pricing.js:
    //  - buildDirection(from, to, mode?)
    //  - quote(direction, amount)
    //  –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã (–ø–æ–¥–∫–ª—é—á–∏ pricing.js –ü–ï–†–ï–î —ç—Ç–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º).
    let rubCnyMode = 'byy'; // –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –¥–ª—è RUB->CNY

    // –ü–µ—Ä–µ—Å—á—ë—Ç (–¥–µ–ª–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥—Ä—É–≥–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º)
    function recalc() {
      const from = selFrom ? selFrom.value : (window.CURRENT_FROM || 'USDT');
      const to   = selTo   ? selTo.value   : (window.CURRENT_TO   || 'RUB');
      const amount = parseFloat(amountInput?.value || '0');

      const direction = typeof buildDirection === 'function'
        ? buildDirection(from, to, rubCnyMode)
        : `${from}>${to}`;

      const q = typeof quote === 'function'
        ? quote(direction, amount)
        : { rate: 0, total: 0 };

      // —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ window, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –≤ send()
      window.currentQuote = q;
      window.currentDirection = direction;
      return q;
    }

    // –ù–∞–≤–µ—Å–∏–º –ø–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    if (selFrom) selFrom.addEventListener('change', recalc);
    if (selTo)   selTo.addEventListener('change', recalc);
    if (amountInput) amountInput.addEventListener('input', recalc);

    // –ü–µ—Ä–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç
    recalc();

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏
    async function send() {
      // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      const q = recalc();

      const payload = {
        type: 'order',
        direction: window.currentDirection,
        from_currency: selFrom ? selFrom.value : undefined,
        to_currency: selTo ? selTo.value : undefined,
        amount: parseFloat(amountInput?.value || '0'),
        rate: q?.rate ?? 0,
        total: q?.total ?? 0,
        contact: (contactInput?.value || '').trim(),
        requisites: (requisitesInput?.value || '').trim(),
        note: (noteInput?.value || '').trim(),
      };

      if (!tg) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É.');
        return;
      }

      try {
        tg.HapticFeedback && tg.HapticFeedback.impactOccurred('medium');
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } catch (e) {
        console.error(e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ù–∞–ø–∏—à–∏—Ç–µ @poizmanager');
      }
    }

    // –ö–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª
    if (sendBtn) sendBtn.addEventListener('click', send);

    // –ö–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É Telegram (MainButton) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
    if (tg && tg.MainButton) {
      tg.MainButton.setText('üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
      tg.MainButton.onClick(send);
      tg.MainButton.show();
    }
  });
</script>
</body>
</html>


if (tg) {
  tg.sendData(JSON.stringify(payload));
  tg.close();
} else {
  alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É.');
}
<script>
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  function isInsideTelegram() {
    try { return !!(tg && tg.initDataUnsafe); } catch (e) { return false; }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram", –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
  (function ensureInsideTelegram(){
    if (!isInsideTelegram()) {
      const box = document.createElement('div');
      box.style.cssText = "position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;padding:24px;text-align:center;";
      box.innerHTML = `
        <div>
          <p style="font:600 18px system-ui;margin-bottom:12px">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–Ω—É—Ç—Ä–∏ Telegram</p>
          <a href="https://t.me/PoizExchangeBot?startapp=calc"
             style="display:inline-block;padding:12px 20px;border-radius:10px;background:#2a9df4;color:#fff;text-decoration:none;font:600 16px system-ui">
            –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
          </a>
        </div>`;
      document.body.appendChild(box);
    } else {
      tg.ready();
      tg.expand();
    }
  })();

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏
  async function sendRequest(payload) {
    if (!isInsideTelegram()) {
      alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É.');
      return;
    }
    try {
      tg.HapticFeedback && tg.HapticFeedback.impactOccurred('medium');
      tg.sendData(JSON.stringify(payload));
      tg.close();
    } catch(e) {
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ù–∞–ø–∏—à–∏—Ç–µ @poizmanager');
      console.error(e);
    }
  }

  // –ü—Ä–∏–º–µ—Ä: –ø–æ–≤–µ—Å—å –Ω–∞ —Ç–≤–æ—é –∫–Ω–æ–ø–∫—É
  // document.getElementById('sendBtn').onclick = () => {
  //   const payload = {...—Å–æ–±–µ—Ä–∏ –ø–æ–ª—è —Ñ–æ—Ä–º—ã..., type:'order'};
  //   sendRequest(payload);
  // };
</script>

