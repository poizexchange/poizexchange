<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./styles.css?v=17" />
  <!-- –í–ê–ñ–ù–û: pricing.js –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html -->
  <script src="./pricing.js?v=17"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –õ—ë–≥–∫–∞—è —Å–µ—Ç–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ styles.css –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è */
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif;background:#f7fbff;color:#0b1a2b}
    header{padding:12px 16px;background:#fff;position:sticky;top:0;z-index:5;border-bottom:1px solid #e7eef7}
    main{padding:16px;max-width:720px;margin:0 auto}
    h2{margin:16px 0 8px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    select,input,textarea{width:100%;padding:12px;border:1px solid #d7e6f7;border-radius:12px;background:#fff;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .result{margin:12px 0;padding:12px;border-radius:12px;background:#eaf4ff;border:1px solid #d7e6f7}
    .btn{display:block;width:100%;padding:14px 16px;border:none;border-radius:12px;background:#cfe7ff;color:#053c7a;font-weight:700;font-size:16px}
    .muted{color:#466}
    footer{height:16px}
    .banner{height:42px;display:flex;align-items:center;gap:12px;font-weight:700;color:#0b63c2}
    .currency-strip{font-size:13px;color:#2a6fb2;opacity:.85}
    .mode-box{display:none;gap:8px;margin-top:8px}
    .btn-ghost{padding:10px 12px;border-radius:10px;border:1px solid #cfe0f5;background:#fff}
    .badge{position:fixed;top:6px;right:8px;z-index:9999;padding:4px 8px;border-radius:8px;background:#e6f1ff;color:#0b63c2;font:600 12px/1.2 system-ui,Segoe UI,Roboto;box-shadow:0 1px 2px rgba(0,0,0,.08)}
  </style>
</head>
<body>
  <!-- –ë–µ–π–¥–∂ –≤–µ—Ä—Å–∏–∏: –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å -->
  <div class="badge">build v17</div>

  <header>
    <div class="banner">Poiz Exchange</div>
    <div class="currency-strip">üá∑üá∫ ‚ÇΩ ¬∑ üá®üá≥ ¬• ¬∑ üá∫üá∏ $ ¬∑ üí≤ USDT ¬∑ ‚Çø BTC ¬∑ Œû ETH ¬∑ …± XMR</div>
  </header>

  <main>
    <h2 style="text-align:center;font-size:22px;margin-top:8px;">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±–º–µ–Ω–∞</h2>

    <label>–û—Ç–¥–∞—é</label>
    <select id="from"></select>

    <label>–ü–æ–ª—É—á–∞—é</label>
    <select id="to"></select>

    <!-- –†–µ–∂–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è RUB‚ÜíCNY -->
    <div id="rubcnyModeBox" class="mode-box">
      <button id="modeByY" class="btn-ghost">RUB‚ÜíCNY –ø–æ ¬•</button>
      <button id="modeFix10" class="btn-ghost">RUB‚ÜíCNY —Ñ–∏–∫—Å 10</button>
    </div>

    <div class="row">
      <div>
        <label>–°—É–º–º–∞</label>
        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="recalcBtn" class="btn" type="button">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
      </div>
    </div>

    <div id="result" class="result">–ö—É—Ä—Å: ‚Äî | –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ‚Äî</div>

    <h2>–ó–∞—è–≤–∫–∞</h2>
    <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
    <input id="contact" placeholder="@username –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" />

    <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã</label>
    <textarea id="requisites" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/–∫–æ—à–µ–ª—å–∫–∞, –±–∞–Ω–∫, –§–ò–û"></textarea>

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <textarea id="note" placeholder="–ì–æ—Ä–æ–¥, –±–∞–Ω–∫, —Å—Ä–æ—á–Ω–æ—Å—Ç—å‚Ä¶"></textarea>

    <label>QR-—Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
    <input type="file" id="qrfile" accept="image/*,.png,.jpg,.jpeg,.webp" />

    <div style="height:10px"></div>
    <button id="sendBtn" class="btn" type="button">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  </main>

  <footer></footer>

  <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JS -->
  <script>
    (function(){
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (tg && tg.showPopup) {
        tg.expand(); tg.ready();
        tg.showPopup({title:"Poiz Exchange", message:"JS loaded (v17) ‚úÖ"});
        console.log("[diag] Telegram WebApp detected, JS v17 loaded");
      } else {
        alert("JS loaded (v17) ‚úÖ ‚Äî –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram");
        console.log("[diag] Not in Telegram, JS v17 loaded");
      }
    })();
  </script>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

      const selFrom = document.getElementById('from');
      const selTo   = document.getElementById('to');
      const amountInput = document.getElementById('amount');
      const resultBox   = document.getElementById('result');
      const btnRecalc   = document.getElementById('recalcBtn');
      const btnSend     = document.getElementById('sendBtn');

      const modeBox = document.getElementById('rubcnyModeBox');
      const btnByY  = document.getElementById('modeByY');
      const btnFix  = document.getElementById('modeFix10');
      let rubCnyMode = 'byy';

      // --- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∞–ª—é—Ç ---
      function fillSelects() {
        const list = (Array.isArray(window.CURRENCIES) && window.CURRENCIES.length)
          ? window.CURRENCIES
          : [
              { code: "RUB",  title: "üá∑üá∫ RUB" },
              { code: "USD",  title: "üá∫üá∏ USD" },
              { code: "USDT", title: "üí≤ USDT" },
              { code: "CNY",  title: "üá®üá≥ CNY" },
              { code: "BTC",  title: "‚Çø BTC" },
              { code: "ETH",  title: "Œû ETH" },
              { code: "XMR",  title: "…± XMR" },
            ];
        [selFrom, selTo].forEach(sel => {
          if (!sel) return;
          sel.innerHTML = "";
          for (const c of list) sel.add(new Option(c.title, c.code));
        });
        if (selFrom && !selFrom.value) selFrom.value = "USDT";
        if (selTo && !selTo.value) selTo.value = "RUB";
        console.log("[diag] selects filled:", selFrom?.value, "‚Üí", selTo?.value);
      }
      fillSelects();
      setTimeout(fillSelects, 400); // –µ—Å–ª–∏ pricing.js –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

      // --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –¥–ª—è RUB‚ÜíCNY ---
      function updateModeVisibility() {
        if (selFrom?.value === 'RUB' && selTo?.value === 'CNY') {
          modeBox.style.display = 'flex';
        } else {
          modeBox.style.display = 'none';
        }
      }

      btnByY?.addEventListener('click', () => { rubCnyMode='byy'; recalc(); });
      btnFix?.addEventListener('click', () => { rubCnyMode='fix'; recalc(); });

      // --- –ü–µ—Ä–µ—Å—á—ë—Ç ---
      function buildDirectionLocal(from, to, mode) {
        if (typeof window.buildDirection === 'function') return window.buildDirection(from, to, mode);
        return `${from}>${to}`;
      }
      function recalc() {
        updateModeVisibility();
        const from = selFrom?.value || 'USDT';
        const to   = selTo?.value   || 'RUB';
        const amount = parseFloat(amountInput?.value || '0');
        const dir = buildDirectionLocal(from, to, rubCnyMode);
        const q = (typeof window.quote === 'function') ? window.quote(dir, amount) : { rate: 0, total: 0 };
        window.currentDirection = dir;
        window.currentQuote = q;
        resultBox.textContent = `–ö—É—Ä—Å: ${q.rate ?? '‚Äî'} | –ö –ø–æ–ª—É—á–µ–Ω–∏—é: ${ (q.total!=null) ? q.total : '‚Äî' }`;
        return q;
      }

      selFrom?.addEventListener('change', recalc);
      selTo?.addEventListener('change', recalc);
      amountInput?.addEventListener('input', recalc);
      btnRecalc?.addEventListener('click', recalc);
      recalc();

      // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ ---
      function send() {
        const q = recalc();
        const payload = {
          action: 'request',                                     // –±–æ—Ç –∂–¥—ë—Ç —ç—Ç–æ –ø–æ–ª–µ
          direction: window.currentDirection,
          from_currency: selFrom?.value,
          to_currency: selTo?.value,
          amount: parseFloat(amountInput?.value || '0'),
          rate: q?.rate ?? 0,
          total: q?.total ?? 0,
          contact: (document.getElementById('contact')?.value || '').trim(),
          requisites: (document.getElementById('requisites')?.value || '').trim(),
          note: (document.getElementById('note')?.value || '').trim(),
          has_qr: !!document.getElementById('qrfile')?.files?.length,
          qr_filename: document.getElementById('qrfile')?.files?.[0]?.name || null
        };

        if (!tg) { alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –≤–Ω—É—Ç—Ä–∏ Telegram'); return; }

        try {
          tg.HapticFeedback && tg.HapticFeedback.impactOccurred('medium');
          tg.sendData(JSON.stringify(payload));
          tg.close();
        } catch (e) {
          console.error(e);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ù–∞–ø–∏—à–∏—Ç–µ @poizmanager');
        }
      }

      btnSend?.addEventListener('click', send);

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî –≥–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram
      if (tg && tg.MainButton) {
        tg.MainButton.setText('üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
        tg.MainButton.onClick(send);
        tg.MainButton.show();
      }

      // –ï—â—ë –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ pricing.js –µ—Å—Ç—å
      console.log("[diag] CURRENCIES typeof:", typeof window.CURRENCIES);
      if (typeof window.CURRENCIES === 'undefined') {
        const msg = "pricing.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–Ω–µ—Ç CURRENCIES). –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å/–∏–º—è —Ñ–∞–π–ª–∞ –∏ 404 –≤ Network.";
        console.warn("[diag]", msg);
        if (tg?.showPopup) tg.showPopup({title:"–í–Ω–∏–º–∞–Ω–∏–µ", message: msg});
      }
    });
  </script>
</body>
</html>

