<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Poiz Exchange — Табло</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css?v=blue-05" />
  <script src="./pricing.js?v=45"></script>
  <style>
    .table-card{ background:#fff; border:1px solid #dbe9ff; border-radius:18px; box-shadow:0 8px 18px rgba(24,97,185,.06); padding:12px; }
    .rates-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .rate-tile{ border:2px solid #d6e6ff; border-radius:16px; padding:12px; background:#fff; }
    .rate-tile h3{ margin:0 0 8px; font-size:15px; color:#28527a; }
    .rate-tile .big{ font-size:22px; font-weight:900; }
    .muted{ color:#6a86aa; font-size:12px; }
  </style>
</head>
<body class="ui-blue">
  <div class="app-scale">

    <!-- БАННЕР -->
    <header class="hero">
      <div class="hero-badge">
        <div class="brand-wrap">
          <div class="brand poiz-express">POIZ</div>
          <div class="brand">EXCHANGE</div>
        </div>
        <div class="flex-spacer"></div>
        <div class="descr">ТАБЛО</div>
      </div>
    </header>

    <main class="wrap">
      <section class="table-card">
        <div class="section-head framed">
          <span class="section-pill">Курсы к рублю</span>
        </div>

        <div id="rates" class="rates-grid"></div>
        <div class="muted" id="ratesInfo" style="margin-top:8px;"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE='https://api.poizexchange.ru';
    const tiles = [
      {code:'USD', title:'Доллар → RUB'},
      {code:'CNY', title:'Юань → RUB'},
      {code:'USDT',title:'USDT → RUB'},
      {code:'BTC', title:'BTC → RUB (оценка)'},
      {code:'ETH', title:'ETH → RUB (оценка)'},
      {code:'ALIPAY', title:'CNY через сервисы (RUB→CNY)'},
    ];

    function fmt(n, d=2){ return Number(n).toLocaleString('ru-RU',{maximumFractionDigits:d}); }

    function computeLocal(){
      // считаем «самый низкий курс из возможных» к рублю
      const out = {};
      // USD→RUB: продаём USD за рубли => 79.50
      out.USD =  window.PRICING.SPOT.RUB_per_USD_cash_buy;
      // CNY→RUB через USDT приблизительно: USDT->RUB 79.5, а CNY/USDT зависит от тира — возьмём консервативно 6.9 CNY/USDT
      const rubPerUsdt = window.PRICING.SPOT.RUB_per_USDT_cash_buy;
      const cnyPerUsdt = 6.90; // минимально для клиента
      out.CNY = (rubPerUsdt / cnyPerUsdt);
      out.USDT = rubPerUsdt;
      out.BTC = window.PRICING.SPOT.RUB_per_BTC;
      out.ETH = window.PRICING.SPOT.RUB_per_ETH;
      out.ALIPAY = 'от ' + fmt(11.75,2) + ' RUB за 1 CNY';
      return out;
    }

    function renderRates(map, info=''){
      const root=document.getElementById('rates');
      root.innerHTML='';
      tiles.forEach(t=>{
        const div=document.createElement('div'); div.className='rate-tile';
        const val = map[t.code];
        div.innerHTML = `<h3>${t.title}</h3><div class="big">${typeof val==='string'? val : fmt(val, (t.code==='BTC'||t.code==='ETH')?0:2)}${typeof val==='string'?'': ' RUB'}</div>`;
        root.appendChild(div);
      });
      document.getElementById('ratesInfo').textContent = info;
    }

    async function refreshRates(){
      // сначала попробуем с бэка
      let info=''; let serverOk=false;
      try{
        await window.PRICING.tryFetchServerPricing();
        serverOk=true; info='Данные с сервера · автообновление 10с';
      }catch(_){}
      const map = computeLocal();
      renderRates(map, info || 'Локальные расчёты · автообновление 10с');
    }

    refreshRates();
    setInterval(refreshRates, 10000);
  </script>
</body>
</html>
