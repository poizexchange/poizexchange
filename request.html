<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Poiz Exchange — Заявка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <h1>Заявка на обмен</h1>

    <label>Направление</label>
    <select id="direction">
      <option value="USDT>RUB">USDT → RUB</option>
      <option value="USD>RUB">USD → RUB</option>
      <option value="USDT>CNY">USDT → CNY</option>
      <option value="RUB>CNY">RUB → CNY</option>
    </select>

    <label>Сумма (отдаю)</label>
    <input type="number" id="amount" min="0" step="0.01" placeholder="Введите сумму" />

    <label>Контакт</label>
    <input type="text" id="contact" placeholder="@username или телефон" />

    <label>Комментарий</label>
    <textarea id="note" rows="3" placeholder="Город, банк, срочность и т.п."></textarea>

    <div id="preview" style="margin:10px 0 0 0;"></div>

    <button id="sendBtn">Отправить заявку</button>
    <p class="hint">В чате придёт номер заявки и сумма к получению.</p>
  </div>

  <script src="pricing.js"></script>
  <script>
    const tg = window.Telegram.WebApp; tg.expand();
    const dirEl = document.getElementById("direction");
    const amtEl = document.getElementById("amount");
    const contactEl = document.getElementById("contact");
    const noteEl = document.getElementById("note");
    const previewEl = document.getElementById("preview");

    function format(n){ return Number(n).toLocaleString('ru-RU', {maximumFractionDigits: 2}); }

    function refreshPreview(){
      const direction = dirEl.value;
      const amount = parseFloat(amtEl.value || "0");
      const q = quote(direction, amount);
      if(!q){ previewEl.textContent = "Введите сумму (>0) для предварительного расчёта."; return; }
      previewEl.innerHTML = `
        <div><b>Курс:</b> ${q.rate}</div>
        <div><b>Комиссия:</b> ${q.feePct}%</div>
        <div><b>К получению:</b> ${format(q.total)}</div>
      `;
    }

    dirEl.addEventListener("change", refreshPreview);
    amtEl.addEventListener("input", refreshPreview);
    refreshPreview();

    document.getElementById("sendBtn").addEventListener("click", () => {
      const payload = {
        action: "request",
        direction: dirEl.value,
        amount: parseFloat(amtEl.value || "0"),
        contact: contactEl.value.trim(),
        note: noteEl.value.trim()
      };
      tg.sendData(JSON.stringify(payload));
      tg.close(); // по желанию
    });
  </script>
</body>
</html>
